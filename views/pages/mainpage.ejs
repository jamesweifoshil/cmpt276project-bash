<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <% include ../partials/header.ejs %>
    <% include ../partials/nav-out.ejs %>
    <link rel="stylesheet" href="/stylesheets/xterm.css" />
    <script src="./script/xterm.js"></script>

  </head>
  <body>
    <% if (user.role === 'admin') { %>
      <h1>You are in Administrator view</h1>
    <% }else { %>
      <h1>Hello user <%=user.username%> </h1>
    <% } %>
    <a class="btn btn-sm btn-danger" href="/logout">Logout</a>
    <a class="btn btn-sm btn-success" href="./fileUpload">Upload an Avatar Image</a>
    <h3>Terminal</h3>
    <div id="terminal"></div>
    <script>
      var term = new Terminal({
        cursorBlink: "block"
      });
      const ws = new WebSocket("ws://localhost:8080", "echo-protocol");
      ws.onmessage = msg => {
        console.log(msg.data);
        var output = msg.data.split("\n")
        for (var x=0; x<output.length; x++ ){
          term.write(output[x]+"\r\n");
        }
        curr_line = "";
      };
      term.open(document.getElementById('terminal'));
      term.write('Hello from \x1B[1;3;31mBash From Anywhere\x1B[0m $ ')
      var curr_line="";
      term.onKey(function(evt) {
        //Enter
        if (evt.domEvent.which === 13) {
          if (curr_line) {
            term.write("\r\n");
            ws.send(curr_line);
            curr_line = "";
          }
        } else if (evt.domEvent.which === 8) {
          // Backspace
          if (curr_line) {
            curr_line = curr_line.slice(0, curr_line.length - 1);
            term.write("\b \b");
          }
        } else {
          curr_line += evt.key;
          term.write(evt.key);
        }
      });
/*
      // paste value
      term.addEventListener('paste',data=>{
        curr_line += data;
        term.write(data);
      });
*/
    </script>

  </body>
</html>
