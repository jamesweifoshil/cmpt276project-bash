<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Upload files to server using Node JS</title>
    <script src="Scripts/jquery-3.1.1.min.js"></script>
    <script src="Scripts/jquery.form.min.js"></script>
</head>
<body>
    <input type="file" id="file-input">
    <p id="status">Please select a file</p>
    <img id="preview" src="/images/default.png">
    
    <form method="POST" action="/save-details">
      <input type="hidden" id="avatar-url" name="avatar-url" value="/images/default.png">
      <input type="text" name="username" placeholder="Username"><br>
      <input type="text" name="full-name" placeholder="Full name"><br><br>
      <input type="submit" value="Update profile">
    </form>
</body>

<script>
    // $(document).ready(function() {
    //             var options = {
    //                     beforeSubmit: showRequest, // pre-submit callback 
    //                     success: showResponse // post-submit callback 
    //                 }; 
    //                 // bind to the form's submit event 
    //                 $('#frmUploader').submit(function () { $(this).ajaxSubmit(options); // always return false to prevent standard browser submit and page navigation 
    //                     return false; }); }); // pre-submit callback 
    // function showRequest(formData, jqForm, options) { alert('Uploading is starting.'); return true; } // post-submit callback function
    // function showResponse(responseText, statusText, xhr, $form) { alert('status: ' + statusText + '\n\nresponseText: \n' + responseText ); };

     /*
      Function to carry out the actual PUT request to S3 using the signed request from the app.
    */
    function uploadFile(file, signedRequest, url){
        const xhr = new XMLHttpRequest();
        xhr.open('PUT', signedRequest);
        xhr.onreadystatechange = () => {
        if(xhr.readyState === 4){
            if(xhr.status === 200){
            document.getElementById('preview').src = url;
            document.getElementById('avatar-url').value = url;
        } else{
            alert('Could not upload file.');
            }
        }
    };
    xhr.send(file);
}

/*
Function to get the temporary signed request from the app.
If request successful, continue to upload the file using this signed
request.
*/
function getSignedRequest(file){
    const xhr = new XMLHttpRequest();
    xhr.open('GET', `/sign-s3?file-name=${file.name}&file-type=${file.type}`);
    xhr.onreadystatechange = () => {
        if(xhr.readyState === 4){
            if(xhr.status === 200){
                const response = JSON.parse(xhr.responseText);
                uploadFile(file, response.signedRequest, response.url);
            } else{
                alert('Could not get signed URL.');
            }
        }
    };
    xhr.send();
}

/*
Function called when file input updated. If there is a file selected, then
start upload procedure by asking for a signed request from the app.
*/
function initUpload(){
    const files = document.getElementById('file-input').files;
    const file = files[0];
    if(file == null){
        return alert('No file selected.');
    }
    getSignedRequest(file);
}

/*
Bind listeners when the page loads.
*/
(() => {
document.getElementById('file-input').onchange = initUpload;
})();


</script>


</html>